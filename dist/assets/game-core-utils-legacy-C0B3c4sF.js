System.register([],function(e,t){"use strict";return{execute:function(){e("E",class{constructor(){this.listeners=new Map,this.eventHistory=[],this.maxHistorySize=1e3,this.debug=!1,this.performanceMetrics={totalEvents:0,averageProcessingTime:0,slowestEvent:null,eventCounts:new Map}}on(e,t,i={}){if("function"!=typeof t)throw new Error("Callback must be a function");this.listeners.has(e)||this.listeners.set(e,[]);const s={callback:t,once:i.once||!1,priority:i.priority||0,id:i.id||null,context:i.context||null};this.listeners.get(e).push(s),this.listeners.get(e).sort((e,t)=>t.priority-e.priority),this.log(`Added listener for event: ${e}`)}once(e,t,i={}){this.on(e,t,{...i,once:!0})}off(e,t){if(!this.listeners.has(e))return;const i=this.listeners.get(e),s=i.findIndex(e=>e.callback===t);-1!==s&&(i.splice(s,1),this.log(`Removed listener for event: ${e}`))}removeAllListeners(e){e?(this.listeners.delete(e),this.log(`Removed all listeners for event: ${e}`)):(this.listeners.clear(),this.log("Removed all listeners"))}removeListener(e,t){return this.off(e,t)}emit(e,t={}){const i=performance.now();if(!this.listeners.has(e))return void this.log(`No listeners for event: ${e}`);const s=this.listeners.get(e),n={event:e,data:t,timestamp:Date.now(),id:this.generateEventId()};this.addToHistory(n),this.updatePerformanceMetrics(e,i);const o=[];for(let a=0;a<s.length;a++){const e=s[a];try{e.context?e.callback.call(e.context,n.data,n):e.callback(n.data,n),e.once&&o.push(a)}catch(r){}}for(let a=o.length-1;a>=0;a--)s.splice(o[a],1);this.log(`Emitted event: ${e}`,n)}async emitAsync(e,t={}){return new Promise((i,s)=>{try{this.emit(e,t),i()}catch(n){s(n)}})}waitFor(e,t=5e3){return new Promise((i,s)=>{const n=setTimeout(()=>{this.off(e,o),s(new Error(`Timeout waiting for event: ${e}`))},t),o=(t,s)=>{clearTimeout(n),this.off(e,o),i({data:t,eventData:s})};this.on(e,o)})}addToHistory(e){this.eventHistory.push(e),this.eventHistory.length>this.maxHistorySize&&this.eventHistory.shift()}updatePerformanceMetrics(e,t){const i=performance.now()-t;this.performanceMetrics.totalEvents++;const s=this.performanceMetrics.averageProcessingTime*(this.performanceMetrics.totalEvents-1);this.performanceMetrics.averageProcessingTime=(s+i)/this.performanceMetrics.totalEvents,(!this.performanceMetrics.slowestEvent||i>this.performanceMetrics.slowestEvent.time)&&(this.performanceMetrics.slowestEvent={event:e,time:i,timestamp:Date.now()});const n=this.performanceMetrics.eventCounts.get(e)||0;this.performanceMetrics.eventCounts.set(e,n+1)}generateEventId(){return`event_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getHistory(e={}){let t=[...this.eventHistory];return e.event&&(t=t.filter(t=>t.event===e.event)),e.since&&(t=t.filter(t=>t.timestamp>=e.since)),e.until&&(t=t.filter(t=>t.timestamp<=e.until)),e.limit&&(t=t.slice(-e.limit)),t}getPerformanceMetrics(){return{...this.performanceMetrics,eventCounts:Object.fromEntries(this.performanceMetrics.eventCounts)}}clearHistory(){this.eventHistory=[],this.log("Event history cleared")}resetMetrics(){this.performanceMetrics={totalEvents:0,averageProcessingTime:0,slowestEvent:null,eventCounts:new Map},this.log("Performance metrics reset")}enableDebug(){this.debug=!0,this.log("Debug mode enabled")}disableDebug(){this.debug=!1}log(e,t=null){this.debug}getListenerCount(e){return this.listeners.has(e)?this.listeners.get(e).length:0}getRegisteredEvents(){return Array.from(this.listeners.keys())}hasListeners(e){return this.listeners.has(e)&&this.listeners.get(e).length>0}createFilter(e,t){return(i,s)=>{t(i,s)&&this.emit(e,i)}}createTransformer(e,t){return(i,s)=>{const n=t(i,s);this.emit(e,n)}}destroy(){this.listeners.clear(),this.eventHistory=[],this.performanceMetrics={totalEvents:0,averageProcessingTime:0,slowestEvent:null,eventCounts:new Map},this.log("EventBus destroyed")}}),e("P",class{constructor(e={}){if(this.eventBus=e.eventBus,this.logger=e.logger,this.config=e.config,!this.eventBus)throw new Error("PerformanceMonitor requires eventBus dependency");if(!this.logger)throw new Error("PerformanceMonitor requires logger dependency");this.config={enableFPSMonitoring:!0,enableMemoryMonitoring:!0,enableAudioMonitoring:!0,enableRenderingMonitoring:!0,enableInputMonitoring:!0,enableNetworkMonitoring:!0,enableAutoOptimization:!0,fpsTarget:60,fpsWarningThreshold:45,fpsCriticalThreshold:30,memoryWarningThreshold:104857600,memoryCriticalThreshold:209715200,frameTimeWarningThreshold:16.67,frameTimeCriticalThreshold:33.33,reportInterval:5e3,maxHistorySize:1e3,...e.config},this.metrics={fps:{current:0,average:0,min:1/0,max:0,history:[],droppedFrames:0},frameTime:{current:0,average:0,min:1/0,max:0,history:[]},memory:{used:0,total:0,available:0,history:[],leakDetected:!1,leakCount:0},audio:{contextState:"suspended",contextRecreations:0,bufferUnderruns:0,latency:0,performanceScore:0},rendering:{drawCalls:0,triangles:0,textures:0,shaders:0,batchCount:0,cullingTime:0,lightingTime:0,postProcessingTime:0},input:{lag:0,eventCount:0,droppedEvents:0,averageResponseTime:0},network:{latency:0,bandwidth:0,packetLoss:0,connectionQuality:"good"}},this.isMonitoring=!1,this.lastFrameTime=0,this.frameCount=0,this.lastReportTime=0,this.optimizationSuggestions=[],this.performanceAlerts=[],this.observers={fps:null,memory:null,audio:null,rendering:null,input:null,network:null},this.setupPerformanceMonitoring(),this.setupEventHandlers(),this.logger.info("PerformanceMonitor initialized")}async initialize(){this.logger.info("Initializing PerformanceMonitor..."),(this.config.enableFPSMonitoring||this.config.enableMemoryMonitoring)&&this.startMonitoring(),this.logger.info("PerformanceMonitor initialized successfully")}cleanup(){this.logger.info("Cleaning up PerformanceMonitor..."),this.stopMonitoring(),this.disconnectObservers(),this.logger.info("PerformanceMonitor cleaned up")}setupPerformanceMonitoring(){this.config.enableFPSMonitoring&&this.setupFPSMonitoring(),this.config.enableMemoryMonitoring&&this.setupMemoryMonitoring(),this.config.enableAudioMonitoring&&this.setupAudioMonitoring(),this.config.enableRenderingMonitoring&&this.setupRenderingMonitoring(),this.config.enableInputMonitoring&&this.setupInputMonitoring(),this.config.enableNetworkMonitoring&&this.setupNetworkMonitoring()}setupEventHandlers(){this.eventBus.on("game:started",this.handleGameStarted.bind(this)),this.eventBus.on("game:paused",this.handleGamePaused.bind(this)),this.eventBus.on("game:resumed",this.handleGameResumed.bind(this)),this.eventBus.on("game:stopped",this.handleGameStopped.bind(this)),this.eventBus.on("performance:frame",this.handleFrame.bind(this)),this.eventBus.on("performance:memory",this.handleMemoryUpdate.bind(this)),this.eventBus.on("performance:audio",this.handleAudioUpdate.bind(this)),this.eventBus.on("performance:rendering",this.handleRenderingUpdate.bind(this)),this.eventBus.on("performance:input",this.handleInputUpdate.bind(this)),this.eventBus.on("performance:network",this.handleNetworkUpdate.bind(this))}setupFPSMonitoring(){this.lastFrameTime=performance.now(),this.frameCount=0;const e=t=>{if(!this.isMonitoring)return;const i=t-this.lastFrameTime;this.lastFrameTime=t;const s=1e3/i;this.updateFPSMetrics(s,i),requestAnimationFrame(e)};this.observers.fps=e}setupMemoryMonitoring(){if(!performance.memory)return void this.logger.warn("Performance.memory API not available");const e=()=>{if(!this.isMonitoring)return;const t=performance.memory;this.updateMemoryMetrics(t),this.detectMemoryLeaks(),setTimeout(e,1e3)};this.observers.memory=e}setupAudioMonitoring(){const e=()=>{this.isMonitoring&&(this.checkAudioContextHealth(),setTimeout(e,2e3))};this.observers.audio=e}setupRenderingMonitoring(){const e=()=>{this.isMonitoring&&(this.updateRenderingMetrics(),requestAnimationFrame(e))};this.observers.rendering=e}setupInputMonitoring(){let e=0;const t=t=>{if(!this.isMonitoring)return;const i=performance.now(),s=i-e;this.updateInputMetrics(s),e=i};document.addEventListener("keydown",t),document.addEventListener("mousedown",t),document.addEventListener("touchstart",t),this.observers.input=t}setupNetworkMonitoring(){const e=()=>{this.isMonitoring&&(this.updateNetworkMetrics(),setTimeout(e,5e3))};this.observers.network=e}startMonitoring(){this.isMonitoring||(this.isMonitoring=!0,this.lastReportTime=performance.now(),this.observers.fps&&requestAnimationFrame(this.observers.fps),this.observers.memory&&this.observers.memory(),this.observers.audio&&this.observers.audio(),this.observers.rendering&&requestAnimationFrame(this.observers.rendering),this.observers.network&&this.observers.network(),this.logger.info("Performance monitoring started"))}stopMonitoring(){this.isMonitoring&&(this.isMonitoring=!1,this.logger.info("Performance monitoring stopped"))}disconnectObservers(){this.observers.input&&(document.removeEventListener("keydown",this.observers.input),document.removeEventListener("mousedown",this.observers.input),document.removeEventListener("touchstart",this.observers.input))}updateFPSMetrics(e,t){this.metrics.fps.current=e,this.metrics.fps.history.push(e),this.metrics.fps.min=Math.min(this.metrics.fps.min,e),this.metrics.fps.max=Math.max(this.metrics.fps.max,e),this.metrics.fps.history.length>0&&(this.metrics.fps.average=this.metrics.fps.history.reduce((e,t)=>e+t,0)/this.metrics.fps.history.length),this.metrics.frameTime.current=t,this.metrics.frameTime.history.push(t),this.metrics.frameTime.min=Math.min(this.metrics.frameTime.min,t),this.metrics.frameTime.max=Math.max(this.metrics.frameTime.max,t),this.metrics.frameTime.history.length>0&&(this.metrics.frameTime.average=this.metrics.frameTime.history.reduce((e,t)=>e+t,0)/this.metrics.frameTime.history.length),t>this.config.frameTimeCriticalThreshold&&this.metrics.fps.droppedFrames++,this.metrics.fps.history.length>this.config.maxHistorySize&&(this.metrics.fps.history.shift(),this.metrics.frameTime.history.shift()),this.checkFPSPerformance()}updateMemoryMetrics(e){this.metrics.memory.used=e.usedJSHeapSize,this.metrics.memory.total=e.totalJSHeapSize,this.metrics.memory.available=e.jsHeapSizeLimit-e.usedJSHeapSize,this.metrics.memory.history.push({used:e.usedJSHeapSize,total:e.totalJSHeapSize,timestamp:performance.now()}),this.metrics.memory.history.length>this.config.maxHistorySize&&this.metrics.memory.history.shift(),this.checkMemoryPerformance()}updateAudioMetrics(e){this.metrics.audio={...this.metrics.audio,...e},this.checkAudioPerformance()}updateRenderingMetrics(){this.metrics.rendering.drawCalls=0,this.metrics.rendering.triangles=0,this.metrics.rendering.textures=0,this.metrics.rendering.shaders=0}updateInputMetrics(e){this.metrics.input.eventCount++,this.metrics.input.lag=e,this.metrics.input.eventCount>0&&(this.metrics.input.averageResponseTime=(this.metrics.input.averageResponseTime*(this.metrics.input.eventCount-1)+e)/this.metrics.input.eventCount),this.checkInputPerformance()}updateNetworkMetrics(){this.metrics.network.latency=0,this.metrics.network.bandwidth=0,this.metrics.network.packetLoss=0,this.metrics.network.connectionQuality="good"}checkFPSPerformance(){const e=this.metrics.fps.current,t=this.metrics.frameTime.current;e<this.config.fpsCriticalThreshold?(this.addPerformanceAlert("critical","FPS critically low",{fps:e,threshold:this.config.fpsCriticalThreshold}),this.suggestOptimization("fps","Consider reducing graphics quality or disabling non-essential features")):e<this.config.fpsWarningThreshold&&this.addPerformanceAlert("warning","FPS below target",{fps:e,threshold:this.config.fpsWarningThreshold}),t>this.config.frameTimeCriticalThreshold?this.addPerformanceAlert("critical","Frame time too high",{frameTime:t,threshold:this.config.frameTimeCriticalThreshold}):t>this.config.frameTimeWarningThreshold&&this.addPerformanceAlert("warning","Frame time above target",{frameTime:t,threshold:this.config.frameTimeWarningThreshold})}checkMemoryPerformance(){const e=this.metrics.memory.used;e>this.config.memoryCriticalThreshold?(this.addPerformanceAlert("critical","Memory usage critically high",{used:e,threshold:this.config.memoryCriticalThreshold}),this.suggestOptimization("memory","Consider reducing texture quality or clearing unused assets")):e>this.config.memoryWarningThreshold&&this.addPerformanceAlert("warning","Memory usage high",{used:e,threshold:this.config.memoryWarningThreshold})}checkAudioPerformance(){this.metrics.audio.contextRecreations>5&&(this.addPerformanceAlert("warning","Audio context recreated multiple times",{recreations:this.metrics.audio.contextRecreations}),this.suggestOptimization("audio","Consider implementing audio context pooling or lazy initialization")),this.metrics.audio.bufferUnderruns>10&&this.addPerformanceAlert("warning","Audio buffer underruns detected",{underruns:this.metrics.audio.bufferUnderruns})}checkInputPerformance(){const e=this.metrics.input.lag;e>100&&(this.addPerformanceAlert("warning","Input lag detected",{lag:e}),this.suggestOptimization("input","Consider optimizing input handling or reducing input processing overhead"))}detectMemoryLeaks(){const e=this.metrics.memory.history;if(e.length<10)return;const t=e.slice(-10);t.every((e,i)=>0===i||e.used>t[i-1].used)&&(this.metrics.memory.leakDetected=!0,this.metrics.memory.leakCount++,this.addPerformanceAlert("warning","Potential memory leak detected",{leakCount:this.metrics.memory.leakCount}),this.suggestOptimization("memory","Check for circular references or unremoved event listeners"))}checkAudioContextHealth(){const e="running";e!==this.metrics.audio.contextState&&("suspended"===this.metrics.audio.contextState&&(this.metrics.audio.contextRecreations++,this.addPerformanceAlert("info","Audio context recreated",{recreations:this.metrics.audio.contextRecreations})),this.metrics.audio.contextState=e)}addPerformanceAlert(e,t,i){const s={level:e,message:t,data:i,timestamp:performance.now()};switch(this.performanceAlerts.push(s),this.eventBus.emit("performance:alert",s),e){case"critical":this.logger.error(`Performance Alert: ${t}`,i);break;case"warning":this.logger.warn(`Performance Alert: ${t}`,i);break;case"info":this.logger.info(`Performance Alert: ${t}`,i)}}suggestOptimization(e,t){const i={category:e,suggestion:t,timestamp:performance.now()};this.optimizationSuggestions.push(i),this.eventBus.emit("performance:optimization",i),this.logger.info(`Performance Optimization: ${t}`)}getPerformanceReport(){return{metrics:this.metrics,alerts:this.performanceAlerts,suggestions:this.optimizationSuggestions,timestamp:performance.now()}}getPerformanceScore(){let e=100;const t=this.metrics.fps.current;t<this.config.fpsCriticalThreshold?e-=40:t<this.config.fpsWarningThreshold&&(e-=20);const i=this.metrics.memory.used/this.metrics.memory.total;i>.9?e-=30:i>.7&&(e-=15);const s=this.metrics.frameTime.current;return s>this.config.frameTimeCriticalThreshold?e-=20:s>this.config.frameTimeWarningThreshold&&(e-=10),Math.max(0,Math.min(100,e))}handleGameStarted(e){this.startMonitoring()}handleGamePaused(e){}handleGameResumed(e){}handleGameStopped(e){this.stopMonitoring()}handleFrame(e){}handleMemoryUpdate(e){this.updateMemoryMetrics(e)}handleAudioUpdate(e){this.updateAudioMetrics(e)}handleRenderingUpdate(e){this.metrics.rendering={...this.metrics.rendering,...e}}handleInputUpdate(e){this.updateInputMetrics(e.responseTime)}handleNetworkUpdate(e){this.metrics.network={...this.metrics.network,...e}}updateConfig(e){this.config={...this.config,...e}}getMetrics(){return this.metrics}getAlerts(){return this.performanceAlerts}getOptimizationSuggestions(){return this.optimizationSuggestions}clearAlerts(){this.performanceAlerts=[]}clearOptimizationSuggestions(){this.optimizationSuggestions=[]}}),e("I",class{constructor(e={}){if(this.eventBus=e.eventBus,this.logger=e.logger,this.config=e.config,!this.eventBus)throw new Error("InputManager requires eventBus dependency");if(!this.logger)throw new Error("InputManager requires logger dependency");this.keys=new Map,this.mouse={x:0,y:0,buttons:new Map,wheel:0},this.touch={touches:new Map,gestures:new Map,activeGestures:new Map,lastTapTime:0,lastTapPosition:{x:0,y:0},longPressTimer:null,doubleTapTimer:null},this.mobileUI={virtualJoystick:{active:!1,center:{x:0,y:0},position:{x:0,y:0},radius:60,touchId:null},actionButtons:new Map,isVisible:!1,orientation:"portrait"},this.gamepad={controllers:new Map,lastUpdate:0},this.keyMappings=new Map,this.mouseMappings=new Map,this.gamepadMappings=new Map,this.touchMappings=new Map,this.accessibility={keyboardNavigation:!1,focusManagement:!0,tabOrder:[],currentFocusIndex:0,focusableElements:new Set,skipLinks:new Map},this.settings={mouseSensitivity:1,keyboardLayout:"qwerty",enableMouseLook:!0,enableKeyboardNavigation:!0,enableGamepad:!0,enableTouch:!0,invertY:!1,deadzone:.1,repeatDelay:500,repeatRate:50,mobileControls:{enabled:!0,layout:"default",size:"medium",opacity:.8,position:"bottom",showLabels:!0,hapticFeedback:!0,gestureSensitivity:1,touchDeadzone:.05,multiTouch:!0,pinchToZoom:!0,swipeThreshold:50,longPressDelay:500,doubleTapDelay:300},gestures:{enableSwipe:!0,enablePinch:!0,enableRotate:!0,enableLongPress:!0,enableDoubleTap:!0,swipeDirections:["up","down","left","right"],pinchThreshold:.1,rotateThreshold:5},mobileUI:{showVirtualJoystick:!0,showActionButtons:!0,showMenuButton:!0,showPauseButton:!0,buttonSpacing:10,buttonSize:60,joystickSize:120,joystickDeadzone:.1,buttonOpacity:.8,buttonPressScale:.9,enableButtonHaptics:!0}},this.boundHandlers=new Map,this.isEnabled=!0,this.isCaptured=!1,this.initializeInputMappings(),this.setupEventHandlers(),this.setupAccessibility(),this.setupMobileControls(),this.logger.info("InputManager initialized")}async initialize(){this.logger.info("Initializing InputManager..."),this.config&&this.loadSettingsFromConfig(),this.setupFocusManagement(),this.logger.info("InputManager initialized successfully")}cleanup(){this.logger.info("Cleaning up InputManager..."),this.removeEventHandlers(),this.keys.clear(),this.mouse.buttons.clear(),this.touch.touches.clear(),this.gamepad.controllers.clear(),this.logger.info("InputManager cleaned up")}update(e){this.isEnabled&&(this.updateGamepadState(),this.updateAccessibilityFeatures(),this.processInputEvents())}initializeInputMappings(){this.keyMappings.set("moveUp",["KeyW","ArrowUp"]),this.keyMappings.set("moveDown",["KeyS","ArrowDown"]),this.keyMappings.set("moveLeft",["KeyA","ArrowLeft"]),this.keyMappings.set("moveRight",["KeyD","ArrowRight"]),this.keyMappings.set("jump",["Space"]),this.keyMappings.set("crouch",["KeyC","ShiftLeft"]),this.keyMappings.set("run",["ShiftLeft"]),this.keyMappings.set("interact",["KeyE","Enter"]),this.keyMappings.set("pause",["Escape","KeyP"]),this.keyMappings.set("inventory",["KeyI","Tab"]),this.keyMappings.set("menu",["Escape","KeyM"]),this.keyMappings.set("confirm",["Enter","Space"]),this.keyMappings.set("cancel",["Escape","Backspace"]),this.keyMappings.set("next",["Tab","ArrowDown"]),this.keyMappings.set("previous",["ShiftLeft+Tab","ArrowUp"]),this.mouseMappings.set("leftClick",0),this.mouseMappings.set("rightClick",2),this.mouseMappings.set("middleClick",1),this.mouseMappings.set("scrollUp","wheelUp"),this.mouseMappings.set("scrollDown","wheelDown"),this.gamepadMappings.set("moveUp","dpadUp"),this.gamepadMappings.set("moveDown","dpadDown"),this.gamepadMappings.set("moveLeft","dpadLeft"),this.gamepadMappings.set("moveRight","dpadRight"),this.gamepadMappings.set("jump","buttonA"),this.gamepadMappings.set("interact","buttonX"),this.gamepadMappings.set("pause","buttonStart"),this.gamepadMappings.set("menu","buttonSelect"),this.gamepadMappings.set("confirm","buttonA"),this.gamepadMappings.set("cancel","buttonB"),this.touchMappings.set("tap","tap"),this.touchMappings.set("doubleTap","doubleTap"),this.touchMappings.set("longPress","longPress"),this.touchMappings.set("swipe","swipe"),this.touchMappings.set("pinch","pinch"),this.touchMappings.set("rotate","rotate")}setupEventHandlers(){this.boundHandlers.set("keydown",this.handleKeyDown.bind(this)),this.boundHandlers.set("keyup",this.handleKeyUp.bind(this)),this.boundHandlers.set("keypress",this.handleKeyPress.bind(this)),this.boundHandlers.set("mousedown",this.handleMouseDown.bind(this)),this.boundHandlers.set("mouseup",this.handleMouseUp.bind(this)),this.boundHandlers.set("mousemove",this.handleMouseMove.bind(this)),this.boundHandlers.set("wheel",this.handleWheel.bind(this)),this.boundHandlers.set("contextmenu",this.handleContextMenu.bind(this)),this.boundHandlers.set("touchstart",this.handleTouchStart.bind(this)),this.boundHandlers.set("touchend",this.handleTouchEnd.bind(this)),this.boundHandlers.set("touchmove",this.handleTouchMove.bind(this)),this.boundHandlers.set("touchcancel",this.handleTouchCancel.bind(this)),this.boundHandlers.set("gamepadconnected",this.handleGamepadConnected.bind(this)),this.boundHandlers.set("gamepaddisconnected",this.handleGamepadDisconnected.bind(this)),this.boundHandlers.set("focusin",this.handleFocusIn.bind(this)),this.boundHandlers.set("focusout",this.handleFocusOut.bind(this)),this.addEventListeners()}addEventListeners(){for(const[e,t]of this.boundHandlers)document.addEventListener(e,t,{passive:!1})}removeEventHandlers(){for(const[e,t]of this.boundHandlers)document.removeEventListener(e,t);this.boundHandlers.clear()}setupAccessibility(){this.settings.enableKeyboardNavigation&&(this.accessibility.keyboardNavigation=!0),this.setupFocusManagement()}setupFocusManagement(){this.updateFocusableElements(),this.updateTabOrder(),this.setupSkipLinks()}updateFocusableElements(){this.accessibility.focusableElements.clear(),document.querySelectorAll(["button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])","a[href]",'[tabindex]:not([tabindex="-1"])','[role="button"]:not([disabled])','[role="link"]','[role="menuitem"]','[role="tab"]','[role="option"]'].join(", ")).forEach(e=>{this.accessibility.focusableElements.add(e)})}updateTabOrder(){this.accessibility.tabOrder=Array.from(this.accessibility.focusableElements).sort((e,t)=>parseInt(e.getAttribute("tabindex")||"0")-parseInt(t.getAttribute("tabindex")||"0"))}setupSkipLinks(){[{id:"skip-main",text:"Skip to main content",target:"main"},{id:"skip-nav",text:"Skip to navigation",target:"nav"},{id:"skip-content",text:"Skip to content",target:"content"}].forEach(e=>{this.accessibility.skipLinks.set(e.id,e)})}setupMobileControls(){this.settings.enableTouch&&this.settings.mobileControls.enabled&&("undefined"!=typeof window&&window.navigator&&window.navigator.userAgent.includes("jsdom")?this.logger.info("Skipping mobile controls setup in test environment"):(this.detectMobileDevice(),this.createMobileUI(),this.setupOrientationHandling(),this.setupGestureRecognition(),this.logger.info("Mobile controls initialized")))}detectMobileDevice(){const e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),t="ontouchstart"in window||navigator.maxTouchPoints>0;this.isMobile=e||t,this.isMobile&&this.logger.info("Mobile device detected")}createMobileUI(){this.isMobile&&(this.mobileControlsContainer=document.createElement("div"),this.mobileControlsContainer.id="mobile-controls",this.mobileControlsContainer.className="mobile-controls",this.mobileControlsContainer.style.cssText=`\n      position: fixed;\n      bottom: 0;\n      left: 0;\n      right: 0;\n      height: 200px;\n      pointer-events: none;\n      z-index: 1000;\n      display: ${this.settings.mobileControls.enabled?"block":"none"};\n    `,this.mobileControlsContainer.nodeType?(this.settings.mobileUI.showVirtualJoystick&&this.createVirtualJoystick(),this.settings.mobileUI.showActionButtons&&this.createActionButtons(),this.settings.mobileUI.showMenuButton&&this.createMenuButton(),this.settings.mobileUI.showPauseButton&&this.createPauseButton(),document.body&&document.body.appendChild(this.mobileControlsContainer)):this.mobileControlsContainer=null)}createVirtualJoystick(){const e=document.createElement("div");e.className="virtual-joystick",e.style.cssText=`\n      position: absolute;\n      left: 20px;\n      bottom: 20px;\n      width: ${this.settings.mobileUI.joystickSize}px;\n      height: ${this.settings.mobileUI.joystickSize}px;\n      pointer-events: auto;\n    `;const t=document.createElement("div");t.className="joystick-base",t.style.cssText=`\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      background: rgba(255, 255, 255, ${this.settings.mobileUI.buttonOpacity});\n      border: 2px solid rgba(0, 0, 0, 0.3);\n      position: relative;\n    `;const i=document.createElement("div");i.className="joystick-knob",i.style.cssText="\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      width: 40px;\n      height: 40px;\n      border-radius: 50%;\n      background: rgba(0, 0, 0, 0.5);\n      transform: translate(-50%, -50%);\n      transition: transform 0.1s ease;\n    ",t.appendChild(i),e.appendChild(t),this.mobileControlsContainer&&this.mobileControlsContainer.appendChild(e),this.mobileUI.virtualJoystick.element=e,this.mobileUI.virtualJoystick.base=t,this.mobileUI.virtualJoystick.knob=i,this.mobileUI.virtualJoystick.center={x:this.settings.mobileUI.joystickSize/2,y:this.settings.mobileUI.joystickSize/2}}createActionButtons(){const e=document.createElement("div");e.className="action-buttons",e.style.cssText=`\n      position: absolute;\n      right: 20px;\n      bottom: 20px;\n      display: flex;\n      flex-direction: column;\n      gap: ${this.settings.mobileUI.buttonSpacing}px;\n      pointer-events: auto;\n    `,[{id:"jump",label:"Jump",key:"Space"},{id:"interact",label:"Interact",key:"KeyE"},{id:"crouch",label:"Crouch",key:"KeyC"},{id:"run",label:"Run",key:"ShiftLeft"}].forEach(t=>{const i=document.createElement("button");i.className=`action-button ${t.id}`,i.textContent=this.settings.mobileControls.showLabels?t.label:"",i.style.cssText=`\n        width: ${this.settings.mobileUI.buttonSize}px;\n        height: ${this.settings.mobileUI.buttonSize}px;\n        border-radius: 50%;\n        background: rgba(255, 255, 255, ${this.settings.mobileUI.buttonOpacity});\n        border: 2px solid rgba(0, 0, 0, 0.3);\n        color: #000;\n        font-size: 12px;\n        font-weight: bold;\n        cursor: pointer;\n        user-select: none;\n        transition: transform 0.1s ease;\n      `,i.addEventListener("touchstart",e=>{e.preventDefault(),this.handleMobileButtonPress(t.id,t.key,"down"),i.style.transform=`scale(${this.settings.mobileUI.buttonPressScale})`}),i.addEventListener("touchend",e=>{e.preventDefault(),this.handleMobileButtonPress(t.id,t.key,"up"),i.style.transform="scale(1)"}),e.appendChild(i),this.mobileUI.actionButtons.set(t.id,i)}),this.mobileControlsContainer&&this.mobileControlsContainer.appendChild(e)}createMenuButton(){const e=document.createElement("button");e.className="menu-button",e.innerHTML="☰",e.style.cssText=`\n      position: absolute;\n      top: 20px;\n      right: 20px;\n      width: ${this.settings.mobileUI.buttonSize}px;\n      height: ${this.settings.mobileUI.buttonSize}px;\n      border-radius: 50%;\n      background: rgba(255, 255, 255, ${this.settings.mobileUI.buttonOpacity});\n      border: 2px solid rgba(0, 0, 0, 0.3);\n      color: #000;\n      font-size: 20px;\n      cursor: pointer;\n      pointer-events: auto;\n      user-select: none;\n    `,e.addEventListener("touchstart",e=>{e.preventDefault(),this.handleMobileButtonPress("menu","KeyM","down")}),this.mobileControlsContainer&&this.mobileControlsContainer.appendChild(e)}createPauseButton(){const e=document.createElement("button");e.className="pause-button",e.innerHTML="⏸",e.style.cssText=`\n      position: absolute;\n      top: 20px;\n      left: 20px;\n      width: ${this.settings.mobileUI.buttonSize}px;\n      height: ${this.settings.mobileUI.buttonSize}px;\n      border-radius: 50%;\n      background: rgba(255, 255, 255, ${this.settings.mobileUI.buttonOpacity});\n      border: 2px solid rgba(0, 0, 0, 0.3);\n      color: #000;\n      font-size: 20px;\n      cursor: pointer;\n      pointer-events: auto;\n      user-select: none;\n    `,e.addEventListener("touchstart",e=>{e.preventDefault(),this.handleMobileButtonPress("pause","Escape","down")}),this.mobileControlsContainer&&this.mobileControlsContainer.appendChild(e)}setupOrientationHandling(){const e=()=>{const e=window.innerHeight>window.innerWidth;this.mobileUI.orientation=e?"portrait":"landscape",this.adjustMobileControlsForOrientation()};window.addEventListener("orientationchange",e),window.addEventListener("resize",e),e()}adjustMobileControlsForOrientation(){this.mobileControlsContainer&&("landscape"===this.mobileUI.orientation?this.mobileControlsContainer.style.height="150px":this.mobileControlsContainer.style.height="200px")}setupGestureRecognition(){(this.settings.gestures.enableSwipe||this.settings.gestures.enablePinch||this.settings.gestures.enableRotate)&&this.setupBasicGestureDetection()}setupBasicGestureDetection(){let e=[],t=0,i=0;document.addEventListener("touchstart",s=>{e=Array.from(s.touches),2===e.length&&(t=this.getDistance(e[0],e[1]),i=this.getAngle(e[0],e[1]))},{passive:!0}),document.addEventListener("touchmove",e=>{if(2===e.touches.length&&this.settings.gestures.enablePinch){const i=this.getDistance(e.touches[0],e.touches[1])/t;Math.abs(i-1)>this.settings.gestures.pinchThreshold&&this.handlePinchGesture(i)}if(2===e.touches.length&&this.settings.gestures.enableRotate){const t=this.getAngle(e.touches[0],e.touches[1])-i;Math.abs(t)>this.settings.gestures.rotateThreshold&&this.handleRotateGesture(t)}},{passive:!0}),document.addEventListener("touchend",t=>{0===t.touches.length&&1===e.length&&this.checkForSwipe(e[0],t.changedTouches[0])},{passive:!0})}handleKeyDown(e){if(!this.isEnabled)return;const t=e.code,i=this.getKeyName(t);this.keys.set(t,{pressed:!0,timestamp:Date.now(),repeat:this.keys.has(t)}),this.accessibility.keyboardNavigation&&this.handleAccessibilityKeyDown(e),this.eventBus.emit("input:keyDown",{key:t,keyName:i,code:e.code,keyCode:e.keyCode,repeat:this.keys.get(t).repeat,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,timestamp:Date.now()}),this.handleMappedAction("keyboard",t,"down",e)}handleKeyUp(e){if(!this.isEnabled)return;const t=e.code,i=this.getKeyName(t);this.keys.set(t,{pressed:!1,timestamp:Date.now(),repeat:!1}),this.eventBus.emit("input:keyUp",{key:t,keyName:i,code:e.code,keyCode:e.keyCode,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,timestamp:Date.now()}),this.handleMappedAction("keyboard",t,"up",e)}handleKeyPress(e){if(!this.isEnabled)return;const t=e.key,i=e.charCode;this.eventBus.emit("input:keyPress",{key:t,charCode:i,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,timestamp:Date.now()})}handleMouseDown(e){if(!this.isEnabled)return;const t=e.button,i=this.getMouseButtonName(t);this.mouse.buttons.set(t,{pressed:!0,timestamp:Date.now()}),this.mouse.x=e.clientX,this.mouse.y=e.clientY,this.eventBus.emit("input:mouseDown",{button:t,buttonName:i,x:e.clientX,y:e.clientY,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,timestamp:Date.now()}),this.handleMappedAction("mouse",t,"down",e)}handleMouseUp(e){if(!this.isEnabled)return;const t=e.button,i=this.getMouseButtonName(t);this.mouse.buttons.set(t,{pressed:!1,timestamp:Date.now()}),this.mouse.x=e.clientX,this.mouse.y=e.clientY,this.eventBus.emit("input:mouseUp",{button:t,buttonName:i,x:e.clientX,y:e.clientY,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,timestamp:Date.now()}),this.handleMappedAction("mouse",t,"up",e)}handleMouseMove(e){if(!this.isEnabled)return;const t=e.clientX-this.mouse.x,i=e.clientY-this.mouse.y;this.mouse.x=e.clientX,this.mouse.y=e.clientY;const s=this.settings.mouseSensitivity,n=t*s,o=this.settings.invertY?-i*s:i*s;this.eventBus.emit("input:mouseMove",{x:e.clientX,y:e.clientY,deltaX:n,deltaY:o,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,timestamp:Date.now()})}handleWheel(e){if(!this.isEnabled)return;const t=e.deltaY,i=t>0?"down":"up";this.mouse.wheel=t,this.eventBus.emit("input:wheel",{deltaY:t,direction:i,x:e.clientX,y:e.clientY,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,timestamp:Date.now()}),this.handleMappedAction("mouse",i,"wheel",e)}handleContextMenu(e){this.isEnabled&&(this.isCaptured&&e.preventDefault(),this.eventBus.emit("input:contextMenu",{x:e.clientX,y:e.clientY,timestamp:Date.now()}))}handleTouchStart(e){if(this.isEnabled&&this.settings.enableTouch){e.preventDefault();for(const t of e.changedTouches)this.touch.touches.set(t.identifier,{x:t.clientX,y:t.clientY,startX:t.clientX,startY:t.clientY,startTime:Date.now(),pressure:t.force||1}),this.isMobile&&this.handleMobileTouchStart(t,e);this.eventBus.emit("input:touchStart",{touches:Array.from(e.changedTouches).map(e=>({id:e.identifier,x:e.clientX,y:e.clientY,pressure:e.force||1})),timestamp:Date.now()})}}handleTouchEnd(e){if(this.isEnabled&&this.settings.enableTouch){e.preventDefault();for(const t of e.changedTouches)this.isMobile&&this.handleMobileTouchEnd(t,e),this.touch.touches.delete(t.identifier);this.eventBus.emit("input:touchEnd",{touches:Array.from(e.changedTouches).map(e=>({id:e.identifier,x:e.clientX,y:e.clientY})),timestamp:Date.now()})}}handleTouchMove(e){if(this.isEnabled&&this.settings.enableTouch){e.preventDefault();for(const t of e.changedTouches)if(this.touch.touches.has(t.identifier)){const i=this.touch.touches.get(t.identifier);i.x=t.clientX,i.y=t.clientY,this.isMobile&&this.handleMobileTouchMove(t,e)}this.eventBus.emit("input:touchMove",{touches:Array.from(e.changedTouches).map(e=>({id:e.identifier,x:e.clientX,y:e.clientY,pressure:e.force||1})),timestamp:Date.now()})}}handleTouchCancel(e){if(this.isEnabled&&this.settings.enableTouch){for(const t of e.changedTouches)this.touch.touches.delete(t.identifier);this.eventBus.emit("input:touchCancel",{touches:Array.from(e.changedTouches).map(e=>({id:e.identifier,x:e.clientX,y:e.clientY})),timestamp:Date.now()})}}handleGamepadConnected(e){if(!this.settings.enableGamepad)return;const t=e.gamepad;this.gamepad.controllers.set(t.index,{id:t.id,index:t.index,connected:!0,buttons:new Map,axes:new Map}),this.logger.info(`Gamepad connected: ${t.id}`),this.eventBus.emit("input:gamepadConnected",{id:t.id,index:t.index,timestamp:Date.now()})}handleGamepadDisconnected(e){const t=e.gamepad;this.gamepad.controllers.delete(t.index),this.logger.info(`Gamepad disconnected: ${t.id}`),this.eventBus.emit("input:gamepadDisconnected",{id:t.id,index:t.index,timestamp:Date.now()})}handleFocusIn(e){if(!this.accessibility.focusManagement)return;const t=e.target,i=this.accessibility.tabOrder.indexOf(t);-1!==i&&(this.accessibility.currentFocusIndex=i),this.eventBus.emit("input:focusIn",{element:t,index:i,timestamp:Date.now()})}handleFocusOut(e){if(!this.accessibility.focusManagement)return;const t=e.target;this.eventBus.emit("input:focusOut",{element:t,timestamp:Date.now()})}handleAccessibilityKeyDown(e){switch(e.key){case"Tab":this.handleTabNavigation(e);break;case"Enter":case" ":this.handleActivation(e);break;case"Escape":this.handleEscape(e);break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":this.handleArrowNavigation(e)}}handleTabNavigation(e){if(0===this.accessibility.tabOrder.length)return;const t=e.shiftKey?-1:1,i=(this.accessibility.currentFocusIndex+t+this.accessibility.tabOrder.length)%this.accessibility.tabOrder.length,s=this.accessibility.tabOrder[i];s&&(s.focus(),this.accessibility.currentFocusIndex=i)}handleActivation(e){const t=document.activeElement;t&&t.click&&t.click()}handleEscape(e){this.eventBus.emit("input:escape",{timestamp:Date.now()})}handleArrowNavigation(e){this.eventBus.emit("input:arrowNavigation",{direction:e.key.replace("Arrow","").toLowerCase(),timestamp:Date.now()})}updateGamepadState(){if(!this.settings.enableGamepad)return;const e=navigator.getGamepads();for(let t=0;t<e.length;t++){const i=e[t];if(!i)continue;const s=this.gamepad.controllers.get(t);if(s){for(let e=0;e<i.buttons.length;e++){const n=i.buttons[e],o=s.buttons.get(e)?.pressed||!1,r=n.pressed;r!==o&&(s.buttons.set(e,{pressed:r,value:n.value,timestamp:Date.now()}),this.eventBus.emit("input:gamepadButton",{controller:t,button:e,pressed:r,value:n.value,timestamp:Date.now()}))}for(let e=0;e<i.axes.length;e++){const n=i.axes[e],o=s.axes.get(e)||0,r=this.settings.deadzone,a=Math.abs(n)<r?0:n;Math.abs(a-o)>.01&&(s.axes.set(e,a),this.eventBus.emit("input:gamepadAxis",{controller:t,axis:e,value:a,timestamp:Date.now()}))}}}}updateAccessibilityFeatures(){this.updateFocusableElements(),this.updateTabOrder()}processInputEvents(){}handleMappedAction(e,t,i,s){let n;switch(e){case"keyboard":n=this.keyMappings;break;case"mouse":n=this.mouseMappings;break;case"gamepad":n=this.gamepadMappings;break;case"touch":n=this.touchMappings;break;default:return}for(const[o,r]of n)r.includes(t)&&this.eventBus.emit("input:action",{action:o,inputType:e,input:t,state:i,event:s,timestamp:Date.now()})}getKeyName(e){return{KeyA:"A",KeyB:"B",KeyC:"C",KeyD:"D",KeyE:"E",KeyF:"F",KeyG:"G",KeyH:"H",KeyI:"I",KeyJ:"J",KeyK:"K",KeyL:"L",KeyM:"M",KeyN:"N",KeyO:"O",KeyP:"P",KeyQ:"Q",KeyR:"R",KeyS:"S",KeyT:"T",KeyU:"U",KeyV:"V",KeyW:"W",KeyX:"X",KeyY:"Y",KeyZ:"Z",Digit0:"0",Digit1:"1",Digit2:"2",Digit3:"3",Digit4:"4",Digit5:"5",Digit6:"6",Digit7:"7",Digit8:"8",Digit9:"9",Space:"Space",Enter:"Enter",Escape:"Escape",Backspace:"Backspace",Tab:"Tab",ShiftLeft:"Left Shift",ShiftRight:"Right Shift",ControlLeft:"Left Ctrl",ControlRight:"Right Ctrl",AltLeft:"Left Alt",AltRight:"Right Alt",ArrowUp:"Up Arrow",ArrowDown:"Down Arrow",ArrowLeft:"Left Arrow",ArrowRight:"Right Arrow"}[e]||e}getMouseButtonName(e){return{0:"Left",1:"Middle",2:"Right",3:"Back",4:"Forward"}[e]||`Button ${e}`}loadSettingsFromConfig(){this.config&&(this.settings={...this.settings,mouseSensitivity:this.config.getConfigValue("input.mouseSensitivity")||this.settings.mouseSensitivity,keyboardLayout:this.config.getConfigValue("input.keyboardLayout")||this.settings.keyboardLayout,enableMouseLook:this.config.getConfigValue("input.enableMouseLook")??this.settings.enableMouseLook,enableKeyboardNavigation:this.config.getConfigValue("input.enableKeyboardNavigation")??this.settings.enableKeyboardNavigation,enableGamepad:this.config.getConfigValue("input.enableGamepad")??this.settings.enableGamepad,enableTouch:this.config.getConfigValue("input.enableTouch")??this.settings.enableTouch,invertY:this.config.getConfigValue("input.invertY")??this.settings.invertY,deadzone:this.config.getConfigValue("input.deadzone")||this.settings.deadzone})}enable(){this.isEnabled=!0,this.logger.info("Input enabled")}disable(){this.isEnabled=!1,this.logger.info("Input disabled")}capture(){this.isCaptured=!0,document.body.style.cursor="none",this.logger.info("Input captured")}release(){this.isCaptured=!1,document.body.style.cursor="default",this.logger.info("Input released")}getInputState(){return{keyboard:Object.fromEntries(this.keys),mouse:this.mouse,touch:Object.fromEntries(this.touch.touches),gamepad:Object.fromEntries(this.gamepad.controllers),accessibility:this.accessibility}}setKeyMapping(e,t){this.keyMappings.set(e,t)}getKeyMapping(e){return this.keyMappings.get(e)||[]}isKeyPressed(e){const t=this.keys.get(e);return!!t&&t.pressed}isMouseButtonPressed(e){const t=this.mouse.buttons.get(e);return!!t&&t.pressed}getMousePosition(){return{x:this.mouse.x,y:this.mouse.y}}getGamepadState(e){return this.gamepad.controllers.get(e)}getAllGamepads(){return Array.from(this.gamepad.controllers.values())}handleMobileTouchStart(e,t){if(this.isTouchOnVirtualJoystick(e))return void this.activateVirtualJoystick(e);const i=this.getTouchedButton(e);i?this.handleMobileButtonPress(i.id,i.key,"down"):this.handleGestureStart(e,t)}handleMobileTouchMove(e,t){this.mobileUI.virtualJoystick.active&&this.mobileUI.virtualJoystick.touchId===e.identifier&&this.updateVirtualJoystick(e),this.handleGestureMove(e,t)}handleMobileTouchEnd(e,t){this.mobileUI.virtualJoystick.active&&this.mobileUI.virtualJoystick.touchId===e.identifier&&this.deactivateVirtualJoystick(),this.handleGestureEnd(e,t)}isTouchOnVirtualJoystick(e){if(!this.mobileUI.virtualJoystick.element)return!1;const t=this.mobileUI.virtualJoystick.element.getBoundingClientRect();return e.clientX>=t.left&&e.clientX<=t.right&&e.clientY>=t.top&&e.clientY<=t.bottom}activateVirtualJoystick(e){this.mobileUI.virtualJoystick.active=!0,this.mobileUI.virtualJoystick.touchId=e.identifier;const t=this.mobileUI.virtualJoystick.element.getBoundingClientRect();this.mobileUI.virtualJoystick.center={x:t.left+t.width/2,y:t.top+t.height/2},this.logger.info("Virtual joystick activated")}updateVirtualJoystick(e){if(!this.mobileUI.virtualJoystick.active)return;const t=this.mobileUI.virtualJoystick.center,i=e.clientX-t.x,s=e.clientY-t.y,n=Math.sqrt(i*i+s*s),o=this.settings.mobileUI.joystickSize/2,r=Math.min(n,o),a=Math.atan2(s,i),h=Math.cos(a)*r,l=Math.sin(a)*r;this.mobileUI.virtualJoystick.knob&&(this.mobileUI.virtualJoystick.knob.style.transform=`translate(calc(-50% + ${h}px), calc(-50% + ${l}px))`);const c=i/o,u=s/o,d=this.settings.mobileUI.joystickDeadzone,m=Math.abs(c)<d?0:c,p=Math.abs(u)<d?0:u;this.eventBus.emit("input:joystickMove",{x:m,y:p,angle:180*a/Math.PI,distance:r/o,timestamp:Date.now()}),this.mapJoystickToKeyboard(m,p)}deactivateVirtualJoystick(){this.mobileUI.virtualJoystick.active=!1,this.mobileUI.virtualJoystick.touchId=null,this.mobileUI.virtualJoystick.knob&&(this.mobileUI.virtualJoystick.knob.style.transform="translate(-50%, -50%)"),this.eventBus.emit("input:joystickRelease",{timestamp:Date.now()}),this.logger.info("Virtual joystick deactivated")}mapJoystickToKeyboard(e,t){const i=.3;e>i?this.handleMappedAction("keyboard","KeyD","down",{synthetic:!0}):e<-.3&&this.handleMappedAction("keyboard","KeyA","down",{synthetic:!0}),t>i?this.handleMappedAction("keyboard","KeyS","down",{synthetic:!0}):t<-.3&&this.handleMappedAction("keyboard","KeyW","down",{synthetic:!0})}getTouchedButton(e){for(const[t,i]of this.mobileUI.actionButtons){const s=i.getBoundingClientRect();if(e.clientX>=s.left&&e.clientX<=s.right&&e.clientY>=s.top&&e.clientY<=s.bottom)return{id:t,key:this.getButtonKey(t)}}return null}getButtonKey(e){return{jump:"Space",interact:"KeyE",crouch:"KeyC",run:"ShiftLeft",menu:"KeyM",pause:"Escape"}[e]||null}handleMobileButtonPress(e,t,i){this.settings.mobileControls.hapticFeedback&&navigator.vibrate&&navigator.vibrate(50),this.eventBus.emit("input:mobileButton",{buttonId:e,key:t,action:i,timestamp:Date.now()}),t&&this.handleMappedAction("keyboard",t,i,{synthetic:!0}),this.logger.info(`Mobile button ${i}: ${e}`)}handleGestureStart(e,t){const i=Date.now();if(this.settings.gestures.enableDoubleTap){const t=i-this.touch.lastTapTime,s=this.getDistance(e,this.touch.lastTapPosition);if(t<this.settings.mobileControls.doubleTapDelay&&s<50)return void this.handleDoubleTap(e)}this.settings.gestures.enableLongPress&&(this.touch.longPressTimer=setTimeout(()=>{this.handleLongPress(e)},this.settings.mobileControls.longPressDelay)),this.touch.lastTapTime=i,this.touch.lastTapPosition={x:e.clientX,y:e.clientY}}handleGestureMove(e,t){this.touch.longPressTimer&&(clearTimeout(this.touch.longPressTimer),this.touch.longPressTimer=null)}handleGestureEnd(e,t){this.touch.longPressTimer&&(clearTimeout(this.touch.longPressTimer),this.touch.longPressTimer=null),this.settings.gestures.enableSwipe&&this.checkForSwipe(e,e)}checkForSwipe(e,t){const i=t.clientX-e.startX,s=t.clientY-e.startY,n=Math.sqrt(i*i+s*s);if(n<this.settings.mobileControls.swipeThreshold)return;const o=180*Math.atan2(s,i)/Math.PI;let r="";o>-45&&o<=45?r="right":o>45&&o<=135?r="down":o>135||o<=-135?r="left":o>-135&&o<=-45&&(r="up"),this.settings.gestures.swipeDirections.includes(r)&&this.handleSwipeGesture(r,n)}handleSwipeGesture(e,t){this.eventBus.emit("input:swipe",{direction:e,distance:t,timestamp:Date.now()}),this.logger.info(`Swipe detected: ${e}`)}handlePinchGesture(e){this.eventBus.emit("input:pinch",{scale:e,timestamp:Date.now()}),this.logger.info(`Pinch detected: ${e.toFixed(2)}`)}handleRotateGesture(e){this.eventBus.emit("input:rotate",{rotation:e,timestamp:Date.now()}),this.logger.info(`Rotate detected: ${e.toFixed(2)}°`)}handleDoubleTap(e){this.eventBus.emit("input:doubleTap",{x:e.clientX,y:e.clientY,timestamp:Date.now()}),this.logger.info("Double tap detected")}handleLongPress(e){this.eventBus.emit("input:longPress",{x:e.clientX,y:e.clientY,timestamp:Date.now()}),this.logger.info("Long press detected")}getDistance(e,t){const i=e.clientX-t.clientX,s=e.clientY-t.clientY;return Math.sqrt(i*i+s*s)}getAngle(e,t){return Math.atan2(t.clientY-e.clientY,t.clientX-e.clientX)}updateMobileControlsVisibility(e){this.mobileUI.isVisible=e,this.mobileControlsContainer&&(this.mobileControlsContainer.style.display=e?"block":"none")}updateMobileSettings(e){this.settings.mobileControls={...this.settings.mobileControls,...e},this.settings.gestures={...this.settings.gestures,...e.gestures},this.settings.mobileUI={...this.settings.mobileUI,...e.mobileUI},this.mobileControlsContainer&&(this.mobileControlsContainer.remove(),this.createMobileUI()),this.logger.info("Mobile settings updated")}getMobileControlsState(){return{isMobile:this.isMobile,isVisible:this.mobileUI.isVisible,orientation:this.mobileUI.orientation,virtualJoystick:{active:this.mobileUI.virtualJoystick.active,position:this.mobileUI.virtualJoystick.position},settings:{mobileControls:this.settings.mobileControls,gestures:this.settings.gestures,mobileUI:this.settings.mobileUI}}}})}}});
//# sourceMappingURL=game-core-utils-legacy-C0B3c4sF.js.map
